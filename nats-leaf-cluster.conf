# NATS Leaf Cluster Configuration - Broadcast Relay
# This is the non-restrictive broadcast relay cluster for Scenario 3
# Acts as a fallback for subscribers with restricted permissions

# Leaf cluster listener (different port from main cluster)
listen: 0.0.0.0:4223

# Enable monitoring endpoint for leaf cluster debugging
http: 0.0.0.0:8223

# TLS Configuration for leaf cluster
# Using same certificates but this cluster is less restrictive
tls: {
  cert_file: "./certs/server-cert.pem"
  key_file: "./certs/server-key.pem"
  ca_file: "./certs/ca-cert.pem"
  verify: true
  verify_and_map: true
  timeout: 2
}

# Leaf Node Configuration - Connect to main cluster
leafnodes: {
  # Listen for connections from main cluster
  listen: "0.0.0.0:7423"
  
  # Don't advertise this leaf node to other clusters
  no_advertise: true
}

# Less restrictive authorization for broadcast relay
authorization {
  # Default permissions allow broader access for broadcast relay
  default_permissions: {
    publish: {
      allow: [">"]
    }
    subscribe: {
      allow: [">"] 
    }
  }
  
  # User definitions with relaxed permissions for broadcast functionality
  users: [
    # Foo user - same full access
    {
      user: "foo@localhost"
      permissions: {
        publish: {
          allow: [">"]
        }
        subscribe: {
          allow: [">"]
        }
      }
    }
    
    # Bar user - EXPANDED access in leaf cluster (this is the key difference!)
    {
      user: "bar@localhost"
      permissions: {
        publish: {
          allow: [">"]  # Full publish access in leaf cluster
        }
        subscribe: {
          allow: [">"]  # Full subscribe access in leaf cluster
        }
      }
    }
    
    # MMM user - full access
    {
      user: "mmm@localhost"
      permissions: {
        publish: {
          allow: [">"]
        }
        subscribe: {
          allow: [">"]
        }
      }
    }
  ]
}

# Logging configuration for debugging leaf cluster
log_file: "./nats-leaf-cluster.log"
debug: true
trace: true
logtime: true

# Server identification
server_name: "leaf-cluster-broadcast-relay"

# Optional: Clustering for leaf cluster high availability
cluster: {
  name: "leaf"
  listen: 0.0.0.0:6223
}

# JetStream (optional - for message persistence in broadcast relay)
# jetstream: {
#   store_dir: "./leaf-jetstream"
#   max_memory_store: 256MB
#   max_file_store: 2GB
# }
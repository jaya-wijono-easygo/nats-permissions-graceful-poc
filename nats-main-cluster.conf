# NATS Main Cluster Configuration for Leaf Node Architecture POC
# This is the primary restrictive cluster with TLS mutual authentication

# Main cluster listener
listen: 0.0.0.0:4222

# Enable monitoring endpoint for debugging  
http: 0.0.0.0:8222

# TLS Mutual Authentication Configuration
tls: {
  cert_file: "./certs/server-cert.pem"
  key_file: "./certs/server-key.pem"
  ca_file: "./certs/ca-cert.pem"
  verify: true
  verify_and_map: true
  timeout: 2
}

# Leaf Node Configuration - Connect to broadcast relay
leafnodes: {
  # Listen port for leaf node connections
  listen: "0.0.0.0:7422"
  
  # Connection to the leaf cluster (broadcast relay)
  remotes: [
    {
      url: "nats://localhost:7423"
    }
  ]
}

# Authorization block - users mapped from client certificate SANs
authorization {
  # Default permissions (if no user matches)
  default_permissions: {
    publish: {
      deny: [">"]
    }
    subscribe: {
      deny: [">"]
    }
  }
  
  # User definitions based on certificate email SANs
  users: [
    # Foo user - mapped from certificate with email SAN (full access)
    {
      user: "foo@localhost"
      permissions: {
        publish: {
          allow: ["rpc.>", "_INBOX.>", "broad.rpc.>", "broadcast.>", "announce.>", "alert.>"]
        }
        subscribe: {
          allow: ["rpc.>", "_INBOX.>", "broad.rpc.>", "broadcast.>", "announce.>", "alert.>"]
        }
      }
    }
    
    # Bar user - mapped from certificate with email SAN (restricted access)
    {
      user: "bar@localhost"
      permissions: {
        publish: {
          allow: ["_INBOX.>", "broad.rpc.>"]
        }
        subscribe: {
          allow: ["_INBOX.>", "broad.rpc.>"]
        }
      }
    }
    
    # MMM user - mapped from certificate with email SAN (full access like Foo)
    {
      user: "mmm@localhost"
      permissions: {
        publish: {
          allow: ["rpc.>", "_INBOX.>", "broad.rpc.>", "broadcast.>", "announce.>", "alert.>"]
        }
        subscribe: {
          allow: ["rpc.>", "_INBOX.>", "broad.rpc.>", "broadcast.>", "announce.>", "alert.>"]
        }
      }
    }
  ]
}

# Logging configuration for debugging
log_file: "./nats-main-cluster.log"
debug: true
trace: true
logtime: true

# Server name for identification
server_name: "main-cluster"

# Clustering (if needed for future expansion)
cluster: {
  name: "main"
  listen: 0.0.0.0:6222
}
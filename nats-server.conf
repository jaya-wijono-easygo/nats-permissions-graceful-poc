# NATS Server Configuration for User Permissions POC with TLS Mutual Authentication
listen: 0.0.0.0:4222

# Enable monitoring endpoint for debugging
http: 0.0.0.0:8222

# TLS Mutual Authentication Configuration
tls: {
  cert_file: "./certs/server-cert.pem"
  key_file: "./certs/server-key.pem"
  ca_file: "./certs/ca-cert.pem"
  verify: true
  verify_and_map: true
  timeout: 2
}

# Authorization block - users mapped from client certificate SANs
authorization {
  # Default permissions (if no user matches)
  default_permissions: {
    publish: {
      deny: [">"]
    }
    subscribe: {
      deny: [">"]
    }
  }
  
  # User definitions based on certificate email SANs
  users: [
    # Foo user - mapped from certificate with email SAN
    {
      user: "foo@localhost"
      permissions: {
        publish: {
          allow: ["rpc.hello.world", "_INBOX.>", "broad.rpc.>"]
        }
        subscribe: {
          allow: ["rpc.hello.world", "_INBOX.>", "broad.rpc.>"]
        }
      }
    }
    
    # Bar user - mapped from certificate with email SAN
    {
      user: "bar@localhost"
      permissions: {
        publish: {
          allow: ["_INBOX.>", "broad.rpc.>"]
        }
        subscribe: {
          allow: ["_INBOX.>", "broad.rpc.>"]
        }
      }
    }
  ]
}

# Logging configuration for debugging
log_file: "./nats-server.log"
debug: true
trace: true
logtime: true
